worker_processes 1;

events {
    worker_connections 1024;
}

error_log /dev/stdout info;

http {
    resolver 127.0.0.11 ipv6=off;
    lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    lua_ssl_verify_depth 5;
    lua_shared_dict jwt_cache 10m;
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    server {
        listen 8080;

        # === CORS ===
        if ($http_origin = "https://solid-eureka-vxv4gv5g7r9fwrj9-3000.app.github.dev") {
            set $cors_origin $http_origin;
        }

        add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        # === No auth needed ===
        location /auth/login     { proxy_pass http://auth:8080; }
        location /auth/register  { proxy_pass http://auth:8080; }

        # === JWT-protected ===
        location /auth/me {
            access_by_lua_file /etc/nginx/lua/jwt.lua;
            proxy_pass http://auth:8080;
        }

        location /auth/refresh {
            set $jwt_verify_exp 0;
            access_by_lua_file /etc/nginx/lua/jwt.lua;
            proxy_pass http://auth:8080;
        }

        location /auth/promote-to-seller {
            access_by_lua_file /etc/nginx/lua/jwt.lua;
            proxy_pass http://auth:8080;
        }

        location /products/store/create {
            access_by_lua_file /etc/nginx/lua/jwt.lua;
            proxy_pass http://products:8080;
        }
    }
}
